<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV.Editor | 在线简历构建器</title>
    
    <!-- 字体库 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Noto+Serif+SC:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Noto Sans SC', 'sans-serif'],
                        serif: ['Noto Serif SC', 'serif'],
                    },
                    colors: {
                        paper: '#ffffff',
                    }
                }
            }
        }
    </script>
    
    <!-- Font Awesome -->
    <link href="https://cdn.staticfile.org/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        /* A4 纸张尺寸模拟 */
        .a4-page {
            width: 210mm;
            min-height: 297mm;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            margin: 0 auto;
            position: relative;
            overflow: hidden;
            transform-origin: top center;
            transition: all 0.3s ease;
        }

        /* 打印优化 */
        @media print {
            body * {
                visibility: hidden;
            }
            #preview-section, #preview-section * {
                visibility: visible;
            }
            #preview-section {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
                background: white;
            }
            .a4-page {
                box-shadow: none;
                margin: 0;
                width: 100%;
                page-break-after: always;
            }
            /* 隐藏非打印元素 */
            .no-print {
                display: none !important;
            }
        }

        /* 自定义滚动条 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }

        /* 照片裁剪容器 */
        .photo-crop-container {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f3f4f6;
        }
        .photo-crop-container img {
            flex-shrink: 0;
            min-width: 100%;
            min-height: 100%;
            object-fit: cover;
            transform-origin: center center;
            transition: transform 0.1s ease-out;
        }
        
        /* 模板特定样式 */
        /* 模板 1: 现代 (Modern) */
        .tpl-modern .resume-header {
            display: flex;
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
            padding: 2rem;
            align-items: center;
        }
        .tpl-modern .resume-body {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            padding: 2rem;
        }
        .tpl-modern .section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #334155;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #334155;
        }

        /* 模板 2: 经典 (Classic) */
        .tpl-classic {
            font-family: 'Noto Serif SC', serif;
            color: #1a202c;
        }
        .tpl-classic .resume-header {
            text-align: center;
            padding: 3rem 2rem 2rem;
            border-bottom: 1px solid #cbd5e1;
        }
        .tpl-classic .photo-wrapper {
            margin: 0 auto 1.5rem;
        }
        .tpl-classic .resume-body {
            padding: 2rem 3rem;
        }
        .tpl-classic .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            border-bottom: 1px solid #cbd5e1;
            padding-bottom: 0.25rem;
            margin-bottom: 1.25rem;
            margin-top: 2rem;
            color: #0f172a;
        }

        /* 模板 3: 极简 (Minimal) */
        .tpl-minimal .resume-header {
            padding: 3rem 3rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }
        .tpl-minimal .resume-body {
            padding: 1rem 3rem 3rem;
        }
        .tpl-minimal .section-title {
            font-weight: 700;
            font-size: 1.5rem;
            color: #2563eb;
            margin-bottom: 1rem;
            margin-top: 2rem;
        }
        .tpl-minimal .left-col {
            padding-right: 2rem;
        }
        
        /* 动态列表动画 */
        .list-enter {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 h-screen overflow-hidden flex flex-col transition-colors duration-300">

    <!-- 顶部工具栏 -->
    <header class="h-16 bg-white dark:bg-gray-800 shadow-sm z-20 flex items-center justify-between px-6 shrink-0 border-b dark:border-gray-700">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white">
                <i class="fa-solid fa-pen-nib"></i>
            </div>
            <h1 class="font-bold text-lg tracking-tight">CV.Editor <span class="text-xs font-normal text-gray-500 bg-gray-100 dark:bg-gray-700 dark:text-gray-400 px-2 py-0.5 rounded ml-2">Beta</span></h1>
        </div>

        <div class="flex items-center gap-4">
            <!-- 缩放控制器 -->
            <div class="hidden md:flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-700 px-3 py-1.5 rounded-full border dark:border-gray-600">
                <i class="fas fa-magnifying-glass-minus text-xs"></i>
                <input type="range" id="preview-zoom" min="0.5" max="1.5" step="0.1" value="0.8" class="w-24 h-1 bg-gray-300 rounded-lg appearance-none cursor-pointer">
                <i class="fas fa-magnifying-glass-plus text-xs"></i>
            </div>

            <button id="theme-toggle" class="w-9 h-9 rounded-full flex items-center justify-center hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-gray-600 dark:text-gray-300">
                <i class="fas fa-moon dark:hidden"></i>
                <i class="fas fa-sun hidden dark:block"></i>
            </button>
            
            <button onclick="window.print()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg text-sm font-medium transition-colors shadow-lg shadow-indigo-500/30 flex items-center gap-2">
                <i class="fas fa-download"></i> 导出 PDF
            </button>
        </div>
    </header>

    <!-- 主体内容：左右分栏 -->
    <main class="flex-1 flex overflow-hidden">
        
        <!-- 左侧：编辑区 -->
        <aside class="w-full md:w-[450px] lg:w-[500px] bg-white dark:bg-gray-800 overflow-y-auto border-r dark:border-gray-700 flex flex-col z-10 shadow-xl no-print">
            
            <!-- 模板选择器 -->
            <div class="p-6 border-b dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50 sticky top-0 z-10 backdrop-blur-md">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">选择模板</h3>
                <div class="grid grid-cols-3 gap-3">
                    <button class="template-btn active ring-2 ring-indigo-500 ring-offset-2 dark:ring-offset-gray-800 bg-white dark:bg-gray-700 border dark:border-gray-600 rounded-lg p-3 text-center transition-all hover:shadow-md" data-tpl="modern">
                        <div class="h-10 w-full bg-gray-200 dark:bg-gray-600 mb-2 rounded flex">
                            <div class="w-1/3 bg-indigo-200 dark:bg-indigo-900 h-full rounded-l"></div>
                        </div>
                        <span class="text-xs font-medium">现代</span>
                    </button>
                    <button class="template-btn bg-white dark:bg-gray-700 border dark:border-gray-600 rounded-lg p-3 text-center transition-all hover:shadow-md" data-tpl="classic">
                        <div class="h-10 w-full bg-gray-200 dark:bg-gray-600 mb-2 rounded flex flex-col items-center pt-1">
                            <div class="w-1/2 h-1 bg-gray-400 dark:bg-gray-500 mb-1"></div>
                            <div class="w-3/4 h-1 bg-gray-300 dark:bg-gray-500"></div>
                        </div>
                        <span class="text-xs font-medium">经典</span>
                    </button>
                    <button class="template-btn bg-white dark:bg-gray-700 border dark:border-gray-600 rounded-lg p-3 text-center transition-all hover:shadow-md" data-tpl="minimal">
                        <div class="h-10 w-full bg-gray-200 dark:bg-gray-600 mb-2 rounded border border-gray-300 dark:border-gray-500"></div>
                        <span class="text-xs font-medium">极简</span>
                    </button>
                </div>
            </div>

            <div class="p-6 space-y-8">
                
                <!-- 模块：照片编辑 -->
                <section>
                    <div class="flex items-center gap-2 mb-4">
                        <i class="fa-solid fa-image text-indigo-500"></i>
                        <h2 class="font-bold text-gray-900 dark:text-gray-100">照片设置</h2>
                    </div>
                    
                    <div class="bg-gray-50 dark:bg-gray-700/50 rounded-xl p-4 border border-gray-200 dark:border-gray-600">
                        <div class="flex gap-4 mb-4">
                            <div class="w-20 h-20 rounded-full bg-gray-200 dark:bg-gray-600 flex-shrink-0 overflow-hidden relative border-2 border-white dark:border-gray-500 shadow-sm">
                                <div class="photo-crop-container">
                                    <img id="editor-avatar-preview" src="https://ui-avatars.com/api/?name=User&background=6366f1&color=fff" style="transform: translate(0px, 0px) scale(1);">
                                </div>
                            </div>
                            <div class="flex-1">
                                <label class="block text-sm font-medium mb-2">上传照片</label>
                                <input type="file" id="photo-upload" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 transition-all cursor-pointer">
                                <p class="text-xs text-gray-400 mt-2">支持 JPG/PNG，可拖动滑块调整位置</p>
                            </div>
                        </div>
                        
                        <!-- 调整滑块 -->
                        <div class="space-y-3">
                            <div>
                                <div class="flex justify-between text-xs text-gray-500 mb-1">
                                    <span>缩放 (Zoom)</span>
                                    <span id="val-scale">1.0x</span>
                                </div>
                                <input type="range" id="control-scale" min="0.5" max="2.5" step="0.1" value="1" class="w-full h-1.5 bg-indigo-200 rounded-lg appearance-none cursor-pointer accent-indigo-600">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <div class="flex justify-between text-xs text-gray-500 mb-1">
                                        <span>水平 X</span>
                                    </div>
                                    <input type="range" id="control-x" min="-100" max="100" step="1" value="0" class="w-full h-1.5 bg-indigo-200 rounded-lg appearance-none cursor-pointer accent-indigo-600">
                                </div>
                                <div>
                                    <div class="flex justify-between text-xs text-gray-500 mb-1">
                                        <span>垂直 Y</span>
                                    </div>
                                    <input type="range" id="control-y" min="-100" max="100" step="1" value="0" class="w-full h-1.5 bg-indigo-200 rounded-lg appearance-none cursor-pointer accent-indigo-600">
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 模块：基本信息 -->
                <section>
                    <div class="flex items-center gap-2 mb-4">
                        <i class="fa-solid fa-user text-indigo-500"></i>
                        <h2 class="font-bold text-gray-900 dark:text-gray-100">基本信息</h2>
                    </div>
                    <div class="grid grid-cols-1 gap-4">
                        <input type="text" data-bind="name" placeholder="你的姓名" class="w-full px-4 py-2 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 focus:ring-2 focus:ring-indigo-500 outline-none transition-all" value="陆远行">
                        <input type="text" data-bind="job" placeholder="求职意向 / 职位" class="w-full px-4 py-2 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 focus:ring-2 focus:ring-indigo-500 outline-none transition-all" value="高级前端工程师">
                        <div class="grid grid-cols-2 gap-4">
                            <input type="text" data-bind="phone" placeholder="电话" class="w-full px-4 py-2 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 focus:ring-2 focus:ring-indigo-500 outline-none" value="138 0013 8000">
                            <input type="text" data-bind="email" placeholder="邮箱" class="w-full px-4 py-2 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 focus:ring-2 focus:ring-indigo-500 outline-none" value="luyuanxing@example.com">
                        </div>
                        <input type="text" data-bind="website" placeholder="个人网站/作品集" class="w-full px-4 py-2 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 focus:ring-2 focus:ring-indigo-500 outline-none" value="github.com/luyuanxing">
                        <textarea data-bind="summary" rows="4" placeholder="个人简介" class="w-full px-4 py-2 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 focus:ring-2 focus:ring-indigo-500 outline-none">拥有5年开发经验的前端专家，热衷于构建高性能、响应式的Web应用。精通React生态系统，对UI/UX有深刻理解。追求代码的简洁与可维护性。</textarea>
                    </div>
                </section>

                <!-- 模块：工作经历 (动态添加版) -->
                <section>
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-briefcase text-indigo-500"></i>
                            <h2 class="font-bold text-gray-900 dark:text-gray-100">工作经历</h2>
                        </div>
                        <!-- 添加按钮 -->
                    </div>
                    
                    <!-- 动态列表容器 -->
                    <div id="experience-list-container" class="space-y-4">
                        <!-- 这里的项目会由 JS 生成 -->
                    </div>

                    <!-- 添加按钮 -->
                    <button id="add-experience-btn" class="w-full mt-4 py-3 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg text-gray-500 hover:text-indigo-600 hover:border-indigo-500 hover:bg-indigo-50 dark:hover:bg-gray-700 transition-all flex items-center justify-center gap-2 text-sm font-medium">
                        <i class="fas fa-plus"></i> 添加经历
                    </button>
                </section>
                
                <!-- 模块：教育 & 技能 -->
                <section>
                    <div class="flex items-center gap-2 mb-4">
                        <i class="fa-solid fa-graduation-cap text-indigo-500"></i>
                        <h2 class="font-bold text-gray-900 dark:text-gray-100">教育 & 技能</h2>
                    </div>
                    <div class="space-y-4">
                        <div>
                             <label class="text-xs text-gray-500 uppercase font-bold mb-1 block">学校信息</label>
                             <input type="text" data-bind="edu-school" class="w-full border-b border-gray-300 dark:border-gray-600 bg-transparent py-1 focus:border-indigo-500 outline-none mb-2" value="上海交通大学 / 计算机科学与技术 / 本科">
                             <input type="text" data-bind="edu-date" class="w-full border-b border-gray-300 dark:border-gray-600 bg-transparent py-1 text-xs text-gray-500 focus:border-indigo-500 outline-none" value="2014.09 - 2018.06">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 uppercase font-bold mb-1 block">技能列表 (用逗号分隔)</label>
                            <textarea data-bind="skills" rows="3" class="w-full px-4 py-2 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 focus:ring-2 focus:ring-indigo-500 outline-none">JavaScript (ES6+), React, Vue.js, Tailwind CSS, Node.js, Webpack, Git, Figma</textarea>
                        </div>
                    </div>
                </section>

                <div class="h-10"></div> <!-- 底部留白 -->
            </div>
        </aside>

        <!-- 右侧：预览区 -->
        <section class="flex-1 bg-gray-200 dark:bg-gray-900/50 overflow-auto flex justify-center p-8 md:p-16 relative" id="preview-container">
            
            <!-- A4 纸张主体 -->
            <div id="resume-preview" class="a4-page tpl-modern text-sm text-gray-800 leading-relaxed print:w-full print:h-full">
                
                <!-- 头部区域 -->
                <div class="resume-header">
                    <div class="photo-wrapper w-32 h-32 rounded-full overflow-hidden border-4 border-white shadow-lg bg-gray-200 shrink-0 mr-8 relative z-10">
                         <div class="photo-crop-container">
                             <img id="preview-avatar" src="https://ui-avatars.com/api/?name=User&background=6366f1&color=fff" style="transform: translate(0px, 0px) scale(1);">
                         </div>
                    </div>
                    
                    <div class="flex-1">
                        <h1 class="text-4xl font-bold text-gray-900 mb-2 leading-tight" id="preview-name">陆远行</h1>
                        <p class="text-xl text-indigo-600 font-medium mb-4" id="preview-job">高级前端工程师</p>
                        
                        <div class="flex flex-wrap gap-x-6 gap-y-2 text-sm text-gray-600">
                            <span class="flex items-center gap-2"><i class="fas fa-phone text-xs text-indigo-400"></i> <span id="preview-phone">138 0013 8000</span></span>
                            <span class="flex items-center gap-2"><i class="fas fa-envelope text-xs text-indigo-400"></i> <span id="preview-email">luyuanxing@example.com</span></span>
                            <span class="flex items-center gap-2"><i class="fas fa-globe text-xs text-indigo-400"></i> <span id="preview-website">github.com/luyuanxing</span></span>
                        </div>
                    </div>
                </div>

                <!-- 内容主体 -->
                <div class="resume-body">
                    <!-- 左栏 / 上栏 -->
                    <div class="left-col">
                        <div class="mb-8">
                            <h3 class="section-title">个人简介</h3>
                            <p class="text-gray-600 text-justify" id="preview-summary">拥有5年开发经验的前端专家，热衷于构建高性能、响应式的Web应用。精通React生态系统，对UI/UX有深刻理解。追求代码的简洁与可维护性。</p>
                        </div>

                        <div class="mb-8">
                            <h3 class="section-title">教育背景</h3>
                            <div class="mb-2">
                                <div class="font-bold text-gray-800" id="preview-edu-school">上海交通大学 / 计算机科学与技术</div>
                                <div class="text-xs text-gray-500 mt-1" id="preview-edu-date">2014.09 - 2018.06</div>
                            </div>
                        </div>

                        <div>
                            <h3 class="section-title">专业技能</h3>
                            <div id="preview-skills" class="flex flex-wrap gap-2">
                                <!-- JS 生成技能标签 -->
                                <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs font-medium">JavaScript</span>
                            </div>
                        </div>
                    </div>

                    <!-- 右栏 / 下栏 -->
                    <div class="right-col">
                        <h3 class="section-title">工作经历</h3>
                        
                        <!-- 动态渲染容器 -->
                        <div id="preview-experience-list">
                            <!-- 这里的项目会由 JS 生成 -->
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // === 状态管理 ===
        const state = {
            photo: {
                scale: 1,
                x: 0,
                y: 0,
                src: 'https://ui-avatars.com/api/?name=User&background=6366f1&color=fff'
            },
            template: 'modern'
        };

        // === DOM 元素引用 ===
        const elements = {
            inputs: document.querySelectorAll('[data-bind]'),
            previewContainer: document.getElementById('resume-preview'),
            photoUpload: document.getElementById('photo-upload'),
            editorAvatar: document.getElementById('editor-avatar-preview'),
            previewAvatar: document.getElementById('preview-avatar'),
            controls: {
                scale: document.getElementById('control-scale'),
                x: document.getElementById('control-x'),
                y: document.getElementById('control-y'),
                valScale: document.getElementById('val-scale')
            },
            tplBtns: document.querySelectorAll('.template-btn'),
            zoomSlider: document.getElementById('preview-zoom'),
            page: document.querySelector('.a4-page'),
            // 新增：动态列表相关
            expListEditor: document.getElementById('experience-list-container'),
            expListPreview: document.getElementById('preview-experience-list'),
            addExpBtn: document.getElementById('add-experience-btn')
        };

        // === 核心功能 1: 静态文本实时同步 ===
        elements.inputs.forEach(input => {
            input.addEventListener('input', (e) => {
                const key = e.target.getAttribute('data-bind');
                const target = document.getElementById(`preview-${key}`);
                
                if (target) {
                    if (key === 'skills') {
                        const skills = e.target.value.split(/,|，/).map(s => s.trim()).filter(s => s);
                        target.innerHTML = skills.map(s => `<span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs font-medium mr-1 mb-1 inline-block">${s}</span>`).join('');
                    } else {
                        target.textContent = e.target.value;
                    }
                }
            });
            input.dispatchEvent(new Event('input'));
        });

        // === 核心功能 1.5: 动态工作经历管理 ===
        
        // 创建编辑器的 HTML 模板
        function createEditorExpHTML(id, data = {}) {
            return `
                <div class="list-enter p-4 bg-gray-50 dark:bg-gray-700/30 rounded-lg border border-gray-200 dark:border-gray-700 relative group" data-exp-id="${id}">
                    <button class="delete-exp-btn absolute top-2 right-2 text-gray-400 hover:text-red-500 p-1 opacity-0 group-hover:opacity-100 transition-opacity" title="删除">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <input type="text" data-field="role" placeholder="职位" class="input-sm w-full bg-transparent border-b border-gray-300 dark:border-gray-600 focus:border-indigo-500 outline-none py-1" value="${data.role || ''}">
                        <input type="text" data-field="company" placeholder="公司名称" class="input-sm w-full bg-transparent border-b border-gray-300 dark:border-gray-600 focus:border-indigo-500 outline-none py-1 text-right" value="${data.company || ''}">
                    </div>
                    <div class="mb-3">
                        <input type="text" data-field="date" placeholder="时间段" class="input-sm w-full bg-transparent border-b border-gray-300 dark:border-gray-600 focus:border-indigo-500 outline-none py-1 text-xs text-gray-500" value="${data.date || ''}">
                    </div>
                    <textarea data-field="desc" rows="3" placeholder="工作内容描述..." class="w-full bg-transparent border border-gray-300 dark:border-gray-600 rounded p-2 text-sm focus:ring-1 focus:ring-indigo-500 outline-none">${data.desc || ''}</textarea>
                </div>
            `;
        }

        // 创建预览区的 HTML 模板
        function createPreviewExpHTML(id, data = {}) {
            return `
                <div class="mb-6 relative pl-4 border-l-2 border-gray-200 preview-item" data-preview-id="${id}">
                    <div class="absolute w-3 h-3 bg-indigo-500 rounded-full -left-[7px] top-1.5 border border-white print:border-none"></div>
                    <div class="flex justify-between items-baseline mb-1">
                        <h4 class="font-bold text-lg text-gray-800" data-view="role">${data.role || '职位名称'}</h4>
                        <span class="text-xs text-gray-500 font-mono" data-view="date">${data.date || '时间段'}</span>
                    </div>
                    <div class="text-indigo-600 font-medium text-sm mb-2" data-view="company">${data.company || '公司名称'}</div>
                    <div class="text-gray-600 text-sm whitespace-pre-line leading-relaxed" data-view="desc">${data.desc || '工作描述...'}</div>
                </div>
            `;
        }

        // 添加新的经历
        function addExperience(data = null) {
            const id = Date.now().toString(); // 生成唯一ID
            const initialData = data || {
                role: '职位名称',
                company: '公司名称',
                date: '2022 - 至今',
                desc: '负责项目开发与维护...'
            };

            // 1. 插入编辑器
            elements.expListEditor.insertAdjacentHTML('beforeend', createEditorExpHTML(id, initialData));
            
            // 2. 插入预览区
            elements.expListPreview.insertAdjacentHTML('beforeend', createPreviewExpHTML(id, initialData));
        }

        // 初始化一些默认数据
        addExperience({
            role: '资深前端开发',
            company: '未来科技有限公司',
            date: '2020.06 - 至今',
            desc: '负责公司核心SaaS产品的重构，将首屏加载时间降低了40%。\n建立内部组件库，提升团队开发效率30%。'
        });
        addExperience({
            role: 'Web 开发工程师',
            company: '创意互动工作室',
            date: '2018.03 - 2020.05',
            desc: '参与多个电商活动页面的开发，实现复杂的动画交互效果。\n使用 Vue.js 重构旧版后台管理系统。'
        });

        // 事件监听：添加按钮
        elements.addExpBtn.addEventListener('click', () => {
            addExperience({ role: '', company: '', date: '', desc: '' });
        });

        // 事件监听：使用事件委托处理动态列表的输入和删除
        elements.expListEditor.addEventListener('click', (e) => {
            // 删除处理
            const deleteBtn = e.target.closest('.delete-exp-btn');
            if (deleteBtn) {
                const item = deleteBtn.closest('[data-exp-id]');
                const id = item.getAttribute('data-exp-id');
                
                // 移除编辑器中的项
                item.remove();
                // 移除预览区中的项
                const previewItem = elements.expListPreview.querySelector(`[data-preview-id="${id}"]`);
                if (previewItem) previewItem.remove();
            }
        });

        elements.expListEditor.addEventListener('input', (e) => {
            // 输入同步处理
            const input = e.target;
            const field = input.getAttribute('data-field');
            if (field) {
                const item = input.closest('[data-exp-id]');
                const id = item.getAttribute('data-exp-id');
                
                // 找到对应的预览项
                const previewItem = elements.expListPreview.querySelector(`[data-preview-id="${id}"]`);
                if (previewItem) {
                    const viewEl = previewItem.querySelector(`[data-view="${field}"]`);
                    if (viewEl) viewEl.innerText = input.value;
                }
            }
        });

        // === 核心功能 2: 照片上传与调整 ===
        
        elements.photoUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    state.photo.src = e.target.result;
                    elements.editorAvatar.src = state.photo.src;
                    elements.previewAvatar.src = state.photo.src;
                    state.photo.scale = 1;
                    state.photo.x = 0;
                    state.photo.y = 0;
                    elements.controls.scale.value = 1;
                    elements.controls.x.value = 0;
                    elements.controls.y.value = 0;
                    updatePhotoTransform();
                }
                reader.readAsDataURL(file);
            }
        });

        function updatePhotoTransform() {
            const transform = `translate(${state.photo.x}px, ${state.photo.y}px) scale(${state.photo.scale})`;
            elements.previewAvatar.style.transform = transform;
            elements.editorAvatar.style.transform = transform; 
        }

        elements.controls.scale.addEventListener('input', (e) => {
            state.photo.scale = parseFloat(e.target.value);
            elements.controls.valScale.textContent = state.photo.scale.toFixed(1) + 'x';
            updatePhotoTransform();
        });

        elements.controls.x.addEventListener('input', (e) => {
            state.photo.x = parseInt(e.target.value);
            updatePhotoTransform();
        });

        elements.controls.y.addEventListener('input', (e) => {
            state.photo.y = parseInt(e.target.value);
            updatePhotoTransform();
        });

        // === 核心功能 3: 模板切换 ===
        elements.tplBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                elements.tplBtns.forEach(b => {
                    b.classList.remove('ring-2', 'ring-indigo-500', 'ring-offset-2');
                    if(document.documentElement.classList.contains('dark')) b.classList.remove('ring-offset-gray-800');
                });
                
                btn.classList.add('ring-2', 'ring-indigo-500', 'ring-offset-2');
                if(document.documentElement.classList.contains('dark')) btn.classList.add('ring-offset-gray-800');

                const tplName = btn.getAttribute('data-tpl');
                elements.previewContainer.classList.remove('tpl-modern', 'tpl-classic', 'tpl-minimal');
                elements.previewContainer.classList.add(`tpl-${tplName}`);
            });
        });

        // === 辅助功能：预览缩放 ===
        elements.zoomSlider.addEventListener('input', (e) => {
            const scale = e.target.value;
            elements.page.style.transform = `scale(${scale})`;
            elements.page.style.marginBottom = `${(scale - 1) * 300}px`; 
        });

        // === 辅助功能：深色模式 ===
        const themeToggle = document.getElementById('theme-toggle');
        const html = document.documentElement;
        
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            html.classList.add('dark');
        }

        themeToggle.addEventListener('click', () => {
            html.classList.toggle('dark');
            localStorage.theme = html.classList.contains('dark') ? 'dark' : 'light';
        });

    </script>
</body>
</html>